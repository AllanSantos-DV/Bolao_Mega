<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
  <title>Hub ‚Ä¢ NovoApp</title>
  <link rel="icon" type="image/x-icon" href="icon/loterias.ico">
  <link rel="shortcut icon" type="image/x-icon" href="icon/loterias.ico">
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: Inter, system-ui, -apple-system, sans-serif; 
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); 
      color: #fff; 
      min-height: 100vh; 
      visibility: hidden;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 40px 20px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      backdrop-filter: blur(10px);
    }
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header p {
      color: #bdbdbd;
      font-size: 16px;
    }
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
    }
    .user-details {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
    }
    .user-name {
      font-weight: 500;
      color: #e0e0e0;
    }
    .logout-btn {
      background: rgba(255,107,107,0.1);
      border: 1px solid rgba(255,107,107,0.3);
      color: #ff6b6b;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .logout-btn:hover {
      background: rgba(255,107,107,0.2);
    }
    .card {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      backdrop-filter: blur(10px);
      transition: all 0.3s;
    }
    .card:hover {
      background: rgba(255,255,255,0.12);
      transform: translateY(-4px);
    }
    .card h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #e0e0e0;
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: 0;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      margin-right: 12px;
      margin-bottom: 12px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,0.15);
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-success {
      background: rgba(0,212,170,0.2);
      color: #00d4aa;
      border: 1px solid rgba(0,212,170,0.3);
    }
    .status-warning {
      background: rgba(255,193,7,0.2);
      color: #ffc107;
      border: 1px solid rgba(255,193,7,0.3);
    }
    .status-error {
      background: rgba(255,107,107,0.2);
      color: #ff6b6b;
      border: 1px solid rgba(255,107,107,0.3);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #bdbdbd;
    }
    .error {
      background: rgba(255,107,107,0.1);
      border: 1px solid rgba(255,107,107,0.3);
      color: #ff6b6b;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-item {
      text-align: center;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 14px;
      color: #bdbdbd;
    }
    .debug-panel {
      position: fixed;
      top: 60px;
      right: 20px;
      width: 320px;
      max-height: 60vh;
      background: rgba(0,0,0,0.9);
      border: 1px solid #0f0;
      color: #0f0;
      padding: 16px;
      overflow: auto;
      z-index: 9999;
      font: 11px/1.4 monospace;
      border-radius: 8px;
      display: none;
    }
    
    .debug-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      background: rgba(0,0,0,0.8);
      border: 1px solid #0f0;
      color: #0f0;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font: 11px monospace;
    }
    
    .tabs-container {
      margin-top: 16px;
    }
    
    .tabs-header {
      display: flex;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 16px;
    }
    
    .tab-btn {
      background: transparent;
      color: #bdbdbd;
      border: none;
      padding: 12px 16px;
      cursor: pointer;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-btn:hover {
      color: #fff;
      background: rgba(255,255,255,0.05);
    }
    
    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .boloes-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .bolao-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .bolao-info h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #fff;
    }
    
    .bolao-info span {
      font-size: 14px;
      color: #bdbdbd;
    }
    
    .bolao-actions {
      display: flex;
      gap: 8px;
    }
    
    .bolao-actions .btn {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .loteria-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }
    
    .loteria-item:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.15);
    }
    
    .loteria-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .loteria-title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin: 0;
    }
    
    .loteria-stats {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: #bdbdbd;
    }
    
    .boloes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    
    .bolao-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.3s ease;
    }
    
    .bolao-card:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
    }
    
    .bolao-card h4 {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin: 0 0 8px 0;
    }
    
    .bolao-card .bolao-meta {
      font-size: 12px;
      color: #bdbdbd;
      margin-bottom: 12px;
    }
    
    .bolao-card .bolao-actions {
      display: flex;
      gap: 8px;
    }
    
    .bolao-card .bolao-actions .btn {
      padding: 4px 6px;
      font-size: 10px;
      flex: 1;
      min-width: 60px;
    }
  </style>
  
         <link rel="stylesheet" href="assets/css/tailwind.min.css">
    <link rel="stylesheet" href="assets/css/hub.css">
</head>
<body>
  <button class="debug-toggle" onclick="toggleDebug()">DEBUG</button>
  <div class="debug-panel" id="debug-panel">
    <div><strong>DEBUG LOGS</strong></div>
    <div id="debug-logs"></div>
  </div>

    <div class="container">
        <div class="header">
      <h1>üéØ NovoApp - Sistema de Bol√µes</h1>
      <p>Hub Moderno - Gest√£o Completa de Bol√µes</p>
    </div>

    <div class="user-info" id="user-info" style="display: none;">
      <div class="user-details">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-name" id="user-name">Usu√°rio</div>
      </div>
      <button class="logout-btn" id="logout-btn">Sair</button>
    </div>

    <div class="card">
      <h3>üß† Controle de Cache</h3>
      <div id="cache-status" class="status status-success">Carregando...</div>
      <div style="margin-top: 16px;">
        <button class="btn" id="btn-limpar-cache">üóëÔ∏è Limpar Cache</button>
        <button class="btn btn-secondary" id="btn-atualizar-cache">üîÑ Atualizar Cache</button>
        <button class="btn btn-secondary" id="btn-validar-concursos">‚úÖ Validar Concursos</button>
      </div>
      <div id="cache-results" style="margin-top: 16px;"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>üë• Participantes <span id="count-participantes" class="badge"></span></h3>
        <button class="btn" onclick="openAdminModal('participantes')">
          ‚ûï Criar
        </button>
        <button class="btn btn-secondary" onclick="listParticipantes()">
          ‚úèÔ∏è Editar
        </button>
      </div>
      
      <div class="card">
        <h3>üé≤ Loterias e Bol√µes <span id="count-loterias" class="badge"></span></h3>
        <button class="btn" onclick="openAdminModal('loterias')">
          ‚ûï Criar Loteria
        </button>
        <button class="btn btn-secondary" onclick="listLoterias()">
          ‚úèÔ∏è Editar
        </button>
        <button class="btn" onclick="openAdminModal('boloes')">
          üéØ Criar Bol√£o
        </button>
      </div>
      
    </div>

    <div class="card">
      <h3>üìä Loterias e Bol√µes</h3>
      <div id="loterias-boloes-container">
        <div id="lotteries-loading" class="loading" aria-live="polite">Carregando loterias...</div>
        <div id="lotteries-container" style="display: none;" role="region" aria-label="Lista de loterias"></div>
        <div id="lotteries-empty" class="empty" style="display: none;" role="status" aria-live="polite">
          <div>Nenhuma loteria com bol√µes no momento</div>
        </div>
            </div>
        </div>

    <div class="card">
      <h3>üìä Relat√≥rios</h3>
      <button class="btn" onclick="window.location.href='/pages/404.html'">
        üìä Relat√≥rios Gerais
      </button>
      <button class="btn btn-secondary" onclick="window.location.href='/pages/404.html'">
        üìà Estat√≠sticas
      </button>
    </div>

    <div class="grid">
      <div class="card">
        <h3>‚ö° Sistema</h3>
        <div style="margin-bottom: 12px;">
          <strong>Status:</strong> <span class="status status-success">Online</span>
        </div>
        <div style="margin-bottom: 12px;">
          <strong>√öltima Atualiza√ß√£o:</strong> <span id="last-update">-</span>
        </div>
        <div style="margin-bottom: 12px;">
          <strong>Ambiente:</strong> <span id="environment">-</span>
        </div>
      </div>
      
      <div class="card">
        <h3>üìà Estat√≠sticas do Sistema</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="total-lotteries">-</div>
            <div class="stat-label">Total de Loterias</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="total-boloes">-</div>
            <div class="stat-label">Total de Bol√µes</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="resultados-prontos">-</div>
            <div class="stat-label">Resultados Prontos</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="app-version">-</div>
            <div class="stat-label">Vers√£o do App</div>
          </div>
        </div>
      </div>
      
    </div>
  </div>

    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
    import { FirestoreAdmin } from './assets/js/admin/firestore-admin.js';
    import { Participante, Loteria, Bolao } from './assets/js/admin/models.js';
    import { AdminManager } from './assets/js/admin/admin-manager.js';
    import { modalManager } from './assets/js/ui/modals.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC-Q2-wknTpBAg1FKKIFwmKzMGpdZfS378",
      authDomain: "mega-bolao-2025.firebaseapp.com",
      projectId: "mega-bolao-2025",
      storageBucket: "mega-bolao-2025.firebasestorage.app",
      messagingSenderId: "607263101053",
      appId: "1:607263101053:web:e6d228034b4643a6412114"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Instanciar FirestoreAdmin e AdminManager
    const firestoreAdmin = new FirestoreAdmin(db);
    const adminManager = new AdminManager(firestoreAdmin);

    window.DEBUG = true;
    window.VERSION = Date.now();
    window.LOGS = [];
    
    function debugLog(category, message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      let sanitizedData = data;
      
      if (data && typeof data === 'object') {
        sanitizedData = { ...data };
        if (sanitizedData.uid) sanitizedData.uid = sanitizedData.uid.substring(0, 8) + '...';
        if (sanitizedData.email) sanitizedData.email = sanitizedData.email.replace(/(.{3}).*(@.*)/, '$1***$2');
      }
      
      const logEntry = `[${timestamp}] [${category}] ${message}${sanitizedData ? ': ' + JSON.stringify(sanitizedData) : ''}`;
      window.LOGS.push(logEntry);
      if (window.DEBUG) console.log(`üîç ${logEntry}`);
    }

    function toggleDebug() {
      const panel = document.getElementById('debug-panel');
      const logs = document.getElementById('debug-logs');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      if (logs) logs.innerHTML = window.LOGS.slice(-50).join('<br>');
    }

    const userInfo = document.getElementById('user-info');
    const userAvatar = document.getElementById('user-avatar');
    const userName = document.getElementById('user-name');
    const logoutBtn = document.getElementById('logout-btn');
    const cacheStatus = document.getElementById('cache-status');
    const lotteriesLoading = document.getElementById('lotteries-loading');
    const lotteriesContainer = document.getElementById('lotteries-container');
    const lotteriesEmpty = document.getElementById('lotteries-empty');
    function showError(message) {
      debugLog('ERROR', message);
      cacheStatus.textContent = message;
      cacheStatus.className = 'status status-error';
    }

    function showSuccess(message) {
      debugLog('SUCCESS', message);
      cacheStatus.textContent = message;
      cacheStatus.className = 'status status-success';
    }

    function showWarning(message) {
      debugLog('WARNING', message);
      cacheStatus.textContent = message;
      cacheStatus.className = 'status status-warning';
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        debugLog('AUTH', 'Usu√°rio autenticado', { uid: user.uid, email: user.email });
        userInfo.style.display = 'flex';
        userName.textContent = user.displayName || user.email || 'Usu√°rio';
        userAvatar.textContent = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
        document.body.style.visibility = 'visible';
        loadData();
      } else {
        debugLog('AUTH', 'Usu√°rio n√£o autenticado, redirecionando...');
        window.location.href = '/pages/login.html';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        debugLog('AUTH', 'Logout realizado');
        window.location.href = '/pages/login.html';
      } catch (error) {
        debugLog('ERROR', 'Erro no logout', error);
      }
    });

    async function loadData() {
      try {
        debugLog('DATA', 'Carregando dados do Firestore...');
        showWarning('Carregando dados...');

        const lotteriesSnapshot = await getDocs(collection(db, 'loterias'));
        const lotteries = [];
        lotteriesSnapshot.forEach(doc => {
          lotteries.push({ id: doc.id, ...doc.data() });
        });

        debugLog('DATA', 'Loterias carregadas', { count: lotteries.length });

        if (lotteries.length > 0) {
          lotteriesLoading.style.display = 'none';
          lotteriesEmpty.style.display = 'none';
          lotteriesContainer.style.display = 'block';
          
          lotteriesContainer.innerHTML = lotteries.map(lottery => `
            <div class="card" style="margin-bottom: 16px;">
              <h4 style="margin-bottom: 8px; color: #e0e0e0;">${lottery.nome || lottery.id}</h4>
              <p style="color: #bdbdbd; font-size: 14px;">Status: <span class="status status-success">Ativo</span></p>
            </div>
          `).join('');
        } else {
          lotteriesLoading.style.display = 'none';
          lotteriesContainer.style.display = 'none';
          lotteriesEmpty.style.display = 'block';
        }

        document.getElementById('total-lotteries').textContent = lotteries.length;
        document.getElementById('total-boloes').textContent = '0';
        document.getElementById('resultados-prontos').textContent = '0';
        document.getElementById('app-version').textContent = window.VERSION;
        document.getElementById('last-update').textContent = new Date().toLocaleString();
        document.getElementById('environment').textContent = window.location.hostname === 'localhost' ? 'Desenvolvimento' : 'Produ√ß√£o';

        showSuccess('Dados carregados com sucesso!');
      } catch (error) {
        debugLog('ERROR', 'Erro ao carregar dados', error);
        showError('Erro ao carregar dados: ' + error.message);
      }
    }

    document.getElementById('btn-limpar-cache').addEventListener('click', () => {
      localStorage.clear();
      sessionStorage.clear();
      showSuccess('Cache limpo com sucesso!');
      debugLog('CACHE', 'Cache limpo');
    });

    document.getElementById('btn-atualizar-cache').addEventListener('click', () => {
      loadData();
    });

    document.getElementById('btn-validar-concursos').addEventListener('click', () => {
      showWarning('Validando concursos...');
      setTimeout(() => {
        showSuccess('Concursos validados!');
      }, 2000);
    });


    // ===== FUN√á√ïES ADMINISTRATIVAS =====
    
    // Modal administrativo
    function openAdminModal(type) {
      debugLog('ADMIN', `Abrindo modal para ${type}`);
      adminManager.openAdminModal(type);
    }
    
    // Listar participantes
    async function listParticipantes() {
      debugLog('ADMIN', 'Listando participantes...');
      try {
        const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js');
        const auth = getAuth();
        if (auth.currentUser) {
          const participantes = await firestoreAdmin.getAllParticipantes();
          const el = document.getElementById('count-participantes');
          if (el) el.textContent = `(${participantes.length})`;
        }
      } catch (e) { /* noop contador */ }
      await adminManager.listParticipantes();
    }
    
    // Buscar participantes
    function searchParticipantes() {
      const termo = prompt('Digite o termo de busca:');
      if (termo) {
        debugLog('ADMIN', 'Buscando participantes', { termo });
        // TODO: Implementar busca de participantes
        alert(`Busca por "${termo}" ser√° implementada`);
      }
    }
    
    // Listar loterias
    async function listLoterias() {
      debugLog('ADMIN', 'Listando loterias...');
      await adminManager.listLoterias();
    }
    
    // Editar loteria
    function editLoteria() {
      debugLog('ADMIN', 'Editando loteria...');
    }
    
    // Listar bol√µes
    async function listBoloes() {
      try {
        debugLog('ADMIN', 'Listando bol√µes...');
      } catch (error) {
        debugLog('ERROR', 'Erro ao listar bol√µes', error);
        showError('Erro ao listar bol√µes: ' + error.message);
      }
    }
    
    // Editar bol√£o
    function editBolao(loteriaId, bolaoId) {
      debugLog('ADMIN', `Editando bol√£o ${bolaoId} da loteria ${loteriaId}`);
      // TODO: Implementar edi√ß√£o de bol√£o
      alert(`Edi√ß√£o do bol√£o ${bolaoId} ser√° implementada`);
    }
    
    
    // ===== FUN√á√ïES DE LOTERIAS E BOL√ïES =====
    
    // Carregar loterias com seus bol√µes
    async function loadLoteriasWithBoloes() {
      try {
        debugLog('LOTERIAS', 'Carregando loterias com bol√µes');
        let loterias = null;
        try {
          const { cacheKeys, swr } = await import('./assets/js/data/local-cache.js');
          const { retry } = await import('./assets/js/data/retry.js');
          const { staleData, refresh } = await swr(
            cacheKeys.loterias,
            () => retry(() => firestoreAdmin.getAllLoterias(), { attempts: 5, baseDelayMs: 300, factor: 2, jitter: 0.3, timeoutMs: 7000 }),
            24*60*60*1000
          );
          loterias = staleData || await refresh;
          // Re-render ap√≥s refresh se inicial veio de cache
          refresh.then(async (fresh) => {
            if (staleData) {
              try {
                const { countersService } = await import('./assets/js/data/counters.js');
                await countersService.updateLoteriasBadge({ loterias: fresh });
              } catch (_) {}
              const container = document.getElementById('lotteries-container');
              if (container) {
                container.innerHTML = '';
                let totalBoloes = 0;
                for (const loteria of fresh) {
                  let boloes = await getBoloesByLoteria(loteria.id || loteria.nome);
                  totalBoloes += boloes.length;
                  if (boloes.length > 0) {
                    const loteriaDiv = await createLoteriaCard(loteria, boloes);
                    container.appendChild(loteriaDiv);
                  }
                }
                document.getElementById('lotteries-loading').style.display = 'none';
                if (totalBoloes === 0) {
                  container.style.display = 'none';
                  document.getElementById('lotteries-empty').style.display = 'block';
                } else {
                  container.style.display = 'block';
                }
              }
            }
          });
        } catch (_) {
          loterias = await firestoreAdmin.getAllLoterias();
        }
        try {
          const { countersService } = await import('./assets/js/data/counters.js');
          await countersService.updateLoteriasBadge({ loterias });
        } catch (_) { /* noop */ }
        const container = document.getElementById('lotteries-container');
        container.innerHTML = '';
        let totalBoloes = 0;
        for (const loteria of loterias) {
          let boloes = null;
          try {
            const { cache, cacheKeys } = await import('./assets/js/data/local-cache.js');
            const key = cacheKeys.boloesByLoteria(loteria.id || loteria.nome);
            if (cache.hasFresh(key)) {
              boloes = cache.get(key);
            }
            if (!boloes) {
              boloes = await getBoloesByLoteria(loteria.id || loteria.nome);
              cache.set(key, boloes, 24*60*60*1000);
            }
          } catch (_) {
            boloes = await getBoloesByLoteria(loteria.id || loteria.nome);
          }
          totalBoloes += boloes.length;
          if (boloes.length > 0) {
            const loteriaDiv = await createLoteriaCard(loteria, boloes);
            container.appendChild(loteriaDiv);
          }
        }
        document.getElementById('lotteries-loading').style.display = 'none';
        if (totalBoloes === 0) {
          container.style.display = 'none';
          document.getElementById('lotteries-empty').style.display = 'block';
          return;
        }
        container.style.display = 'block';
      } catch (error) {
        debugLog('ERROR', 'Erro ao carregar loterias com bol√µes', error);
        document.getElementById('lotteries-loading').style.display = 'none';
        document.getElementById('lotteries-empty').style.display = 'block';
      }
    }

    // Criar card de loteria com bol√µes
    async function createLoteriaCard(loteria, boloes) {
      const loteriaDiv = document.createElement('div');
      loteriaDiv.className = 'loteria-item';
      loteriaDiv.innerHTML = `
        <div class="loteria-header">
          <h3 class="loteria-title">${loteria.Nome || loteria.nome}</h3>
          <div class="loteria-stats">
            <span>${boloes.length} bol√µes</span>
            <span>R$ ${loteria.valor_volante || '0,00'}</span>
          </div>
        </div>
        <div class="boloes-grid" id="boloes-${loteria.id || loteria.nome}">
          ${boloes.map(bolao => `
              <div class="bolao-card">
                <h4>${bolao.nome}</h4>
                <div class="bolao-meta">
                  ${bolao.jogos?.total_jogos || 0} jogos ‚Ä¢ 
                  ${bolao.concursos_alvo?.length || 0} concursos ‚Ä¢ 
                  ${bolao.participantes?.length || 0} participantes
                </div>
                <div class="bolao-actions">
                  <button class="btn" onclick="shareBolao('${loteria.id || loteria.nome}', '${bolao.id}')">üîó Link</button>
                  <button class="btn btn-secondary" onclick="viewBolao('${loteria.id || loteria.nome}', '${bolao.id}')">üëÅÔ∏è Visualizar</button>
                  <button class="btn btn-secondary" onclick="editBolao('${loteria.id || loteria.nome}', '${bolao.id}')">‚úèÔ∏è Editar</button>
                </div>
              </div>
            `).join('')}
        </div>
      `;
      return loteriaDiv;
    }
    
    // Fun√ß√£o para buscar bol√µes por loteria
    async function getBoloesByLoteria(loteriaId) {
      try {
        debugLog('FIRESTORE', `Buscando bol√µes para loteria ${loteriaId}`);
        const boloes = await firestoreAdmin.getBoloesByLoteria(loteriaId);
        return boloes;
      } catch (error) {
        debugLog('ERROR', `Erro ao buscar bol√µes para ${loteriaId}`, error);
        return [];
      }
    }
    
    // Compartilhar bol√£o
    function shareBolao(loteria, bolaoId) {
      const url = `${window.location.origin}/pages/bolao-template.html?loteria=${loteria}&bolao=${bolaoId}`;
      navigator.clipboard.writeText(url).then(() => {
        showSuccess('Link copiado para a √°rea de transfer√™ncia!');
        debugLog('SHARE', `Link compartilhado: ${url}`);
      }).catch(() => {
        // Fallback para navegadores sem clipboard API
        prompt('Copie o link do bol√£o:', url);
      });
    }
    
    // Ver bol√£o
    function viewBolao(loteria, bolaoId) {
      const url = `/pages/bolao-template.html?loteria=${loteria}&bolao=${bolaoId}`;
      window.open(url, '_blank');
      debugLog('VIEW', `Abrindo bol√£o: ${loteria}/${bolaoId}`);
    }
    
    // Expor fun√ß√µes globalmente
    window.openAdminModal = openAdminModal;
    window.listParticipantes = listParticipantes;
    window.searchParticipantes = searchParticipantes;
    window.listLoterias = listLoterias;
window.modalManager = modalManager;
window.participantesManager = adminManager.participantesManager;
window.loteriasManager = adminManager.loteriasManager;
window.editLoteria = editLoteria;
    window.listBoloes = listBoloes;
    window.editBolao = editBolao;
    window.shareBolao = shareBolao;
    window.viewBolao = viewBolao;
    window.loadLoteriasWithBoloes = loadLoteriasWithBoloes;

    // Inicializar loterias com bol√µes
    loadLoteriasWithBoloes();

    // Atualizar contador de participantes ao autenticar
    (async () => {
      try {
        const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js');
        const { countersService } = await import('./assets/js/data/counters.js');
        const auth = getAuth();
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            try {
              let isAdmin = false;
              try { await firestoreAdmin.checkAdminPermission(); isAdmin = true; } catch (_) { isAdmin = false; }
              await countersService.updateParticipantesBadge(() => firestoreAdmin.getAllParticipantes(), isAdmin);
              if (!isAdmin) {
                const el = document.getElementById('count-participantes');
                if (el) el.textContent = '';
              }
            } catch (_) { /* noop */ }
          } else {
            const el = document.getElementById('count-participantes');
            if (el) el.textContent = '';
          }
        });
      } catch (_) { /* noop */ }
    })();

    // Revalidar ao ganhar foco/voltar online (loterias + badges)
    (async () => {
      try {
        const handler = async () => {
          try {
            await loadLoteriasWithBoloes();
          } catch (_) {}
        };
        window.addEventListener('focus', handler);
        window.addEventListener('online', handler);
      } catch (_) {}
    })();

    // Sincronizar entre abas: se invalida√ß√£o ocorrer em outra aba
    (async () => {
      try {
        const { cachePrefix } = await import('./assets/js/data/local-cache.js');
        window.addEventListener('storage', (e) => {
          if (e.key && e.key.startsWith(cachePrefix)) {
            // chave de cache alterada/limpa -> revalidar vis√£o
            loadLoteriasWithBoloes();
          }
        });
      } catch (_) {}
    })();

    debugLog('SYSTEM', 'NovoApp Hub inicializado', { version: window.VERSION });
    </script>
</body>
</html>