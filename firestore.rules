rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    // Função para verificar se usuário é admin
    function isAdmin() {
      // Qualquer usuário autenticado no Firebase é considerado admin
      return request.auth != null;
    }

    // Função para verificar se usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Coleções públicas (leitura para todos, escrita apenas para admin)
    match /public/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Loterias (leitura pública, escrita apenas admin com validação)
    match /loterias/{loteria} {
      allow read: if true;
      allow write: if isAdmin() &&
        request.resource.data.keys().hasAll(['nome', 'created_at', 'updated_at']) &&
        request.resource.data.nome is string &&
        request.resource.data.nome.size() >= 3 &&
        request.resource.data.nome.size() <= 100;
    }
    
    // Loterias (coleção completa)
    match /loterias {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /loterias/{loteria}/concursos/{concurso} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Cache (leitura pública, escrita apenas admin)
    match /cache/{loteria}/{concurso} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Configurações (leitura pública, escrita apenas admin)
    match /config/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Bolões (leitura pública, escrita apenas admin com validação)
    match /boloes/{bolao} {
      allow read: if true;
      allow write: if isAdmin() &&
        request.resource.data.keys().hasAll(['nome', 'loteria_id', 'created_at', 'updated_at']) &&
        request.resource.data.nome is string &&
        request.resource.data.nome.size() >= 3 &&
        request.resource.data.nome.size() <= 100 &&
        request.resource.data.loteria_id is string &&
        request.resource.data.loteria_id.size() > 0;
    }
    
    // Bolões (coleção completa)
    match /boloes {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Participantes (somente admins podem ler/escrever — PII protegida com validação)
    match /participantes/{participante} {
      allow read: if isAdmin();
      allow write: if isAdmin() &&
        request.resource.data.keys().hasAll(['nome', 'created_at', 'updated_at']) &&
        request.resource.data.nome is string &&
        request.resource.data.nome.size() >= 3 &&
        request.resource.data.nome.size() <= 100 &&
        (!('telefone' in request.resource.data) || request.resource.data.telefone is string) &&
        (!('chavepix' in request.resource.data) || request.resource.data.chavepix is string);
    }
    
    // Participantes (coleção completa)
    match /participantes {
      allow read, write: if isAdmin();
    }

    // Usuários admin (apenas admin pode ler/escrever)
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }

    // Uploads de arquivos (apenas admin)
    match /uploads/{document=**} {
      allow read, write: if isAdmin();
    }

    // Regra padrão - negar tudo
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
